<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vacation Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: calc(100% - 250px); transition: height 0.5s ease; }
    #controls { padding: 5px; background: #f0f0f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    #galleryContainer { height: 250px; overflow-x: auto; background: #f9f9f9; padding: 5px; display: flex; flex-wrap: nowrap; }
    .gallery-photo { height: 100%; margin-right: 10px; border-radius: 8px; }
    .popup-image { max-width: 200px; max-height: 150px; display: block; margin-bottom: 4px; }
    .popup-caption { font-size: 14px; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="timelineSlider">Timeline:</label>
    <input type="range" id="timelineSlider" min="0" max="100" value="100" step="1" />
    <span id="timelineYearLabel"></span>
    <button id="timelinePlay">▶</button>
    <button id="timelinePause" disabled>⏸</button>
  </div>
  <div id="map"></div>
  <div id="galleryContainer"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let tripPath = [];
    let timelineTimer = null;
    let tripCarMarker = null;
    let tripCarIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/744/744465.png",
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });

    function loadMarkers(photos) {
      map.eachLayer(layer => {
        if (layer instanceof L.Marker && layer !== tripCarMarker) map.removeLayer(layer);
      });
      document.getElementById("galleryContainer").innerHTML = '';
      photos.forEach(photo => {
        const marker = L.marker([photo.lat, photo.lng]).addTo(map);
        marker.bindPopup(`
          <img src="${photo.path}" class="popup-image">
          <div class="popup-caption">${photo.caption || ''}</div>
          <button onclick="window.open('https://www.google.com/maps?q=&layer=c&cbll=${photo.lat},${photo.lng}', '_blank')">Street View</button>
        `);
        const img = document.createElement('img');
        img.src = photo.path;
        img.className = 'gallery-photo';
        document.getElementById("galleryContainer").appendChild(img);
      });
    }

    function updateTimelineSlider(percent) {
      const cutoff = Math.floor(tripPath.length * percent / 100);
      const filtered = tripPath.slice(0, cutoff);
      const currentYear = cutoff > 0 ? tripPath[cutoff - 1].date.getFullYear() : '';
      document.getElementById("timelineYearLabel").textContent = currentYear;
      loadMarkers(filtered);
      if (cutoff > 0 && tripPath[cutoff - 1].lat && tripPath[cutoff - 1].lng) {
        const coord = [tripPath[cutoff - 1].lat, tripPath[cutoff - 1].lng];
        if (!tripCarMarker) {
          tripCarMarker = L.marker(coord, { icon: tripCarIcon }).addTo(map);
        } else {
          tripCarMarker.setLatLng(coord);
        }
      }
    }

    document.getElementById("timelineSlider").addEventListener("input", (e) => {
      updateTimelineSlider(+e.target.value);
    });

    document.getElementById("timelinePlay").addEventListener("click", () => {
      const slider = document.getElementById("timelineSlider");
      document.getElementById("timelinePlay").disabled = true;
      document.getElementById("timelinePause").disabled = false;
      timelineTimer = setInterval(() => {
        let val = +slider.value;
        if (val >= 100) {
          clearInterval(timelineTimer);
          timelineTimer = null;
          document.getElementById("timelinePlay").disabled = false;
          document.getElementById("timelinePause").disabled = true;
          return;
        }
        slider.value = val + 1;
        updateTimelineSlider(val + 1);
      }, 1000);
    });

    document.getElementById("timelinePause").addEventListener("click", () => {
      clearInterval(timelineTimer);
      timelineTimer = null;
      document.getElementById("timelinePlay").disabled = false;
      document.getElementById("timelinePause").disabled = true;
    });

    // Load JSON and build tripPath
    fetch("photos.json")
      .then(res => res.json())
      .then(data => {
        tripPath = data.map(p => ({
          ...p,
          date: new Date(p.date || "1970-01-01")
        })).sort((a, b) => a.date - b.date);
        updateTimelineSlider(100);
      });
  </script>
</body>
</html>
